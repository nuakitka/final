{% extends "base.html" %}

{% block title %}–î–æ–±–∞–≤–∏—Ç—å –∫–Ω–∏–≥—É - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- –•–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏ -->
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/admin">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</a></li>
                <li class="breadcrumb-item active">–î–æ–±–∞–≤–∏—Ç—å –∫–Ω–∏–≥—É</li>
            </ol>
        </nav>

        <h1 class="mb-4">
            <i class="bi bi-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∫–Ω–∏–≥—É
        </h1>

        <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–Ω–∏–≥–∏ -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–Ω–∏–≥–µ</h5>
            </div>
            <div class="card-body">
                <form id="addBookForm">
                    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label for="title" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏ *</label>
                            <input type="text" class="form-control" id="title" name="title" required>
                        </div>
                        <div class="col-md-4">
                            <label for="subtitle" class="form-label">–ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫</label>
                            <input type="text" class="form-control" id="subtitle" name="subtitle">
                        </div>
                    </div>

                    <!-- –ê–≤—Ç–æ—Ä—ã -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="authors" class="form-label">–ê–≤—Ç–æ—Ä—ã *</label>
                            <select class="form-select" id="authors" name="author_ids" multiple required>
                                <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –∞–≤—Ç–æ—Ä–æ–≤...</option>
                            </select>
                            <div class="d-flex justify-content-between align-items-center mt-1 flex-wrap gap-1">
                                <div class="form-text">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ—Ä–æ–≤ (Ctrl+–∫–ª–∏–∫ –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞)</div>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-secondary" onclick="removeSelectedAuthors()">
                                        –£–±—Ä–∞—Ç—å –∏–∑ –∫–Ω–∏–≥–∏
                                    </button>
                                    <button type="button" class="btn btn-outline-danger" onclick="deleteSelectedAuthorsPermanently()">
                                        –£–¥–∞–ª–∏—Ç—å –∏–∑ —Å–∏—Å—Ç–µ–º—ã
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –∞–≤—Ç–æ—Ä–∞</label>
                            <div class="input-group mb-2">
                                <input type="text" class="form-control" id="newAuthorFirstName" placeholder="–ò–º—è">
                                <input type="text" class="form-control" id="newAuthorLastName" placeholder="–§–∞–º–∏–ª–∏—è">
                                <button type="button" class="btn btn-outline-secondary" onclick="addNewAuthor()">
                                    <i class="bi bi-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="categories" class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</label>
                            <select class="form-select" id="categories" name="category_ids" multiple>
                                <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π...</option>
                            </select>
                            <div class="d-flex justify-content-between align-items-center mt-1 flex-wrap gap-1">
                                <div class="form-text">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</div>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-secondary" onclick="removeSelectedCategories()">
                                        –£–±—Ä–∞—Ç—å –∏–∑ –∫–Ω–∏–≥–∏
                                    </button>
                                    <button type="button" class="btn btn-outline-danger" onclick="deleteSelectedCategoriesPermanently()">
                                        –£–¥–∞–ª–∏—Ç—å –∏–∑ —Å–∏—Å—Ç–µ–º—ã
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="newCategoryName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏">
                                <button type="button" class="btn btn-outline-secondary" onclick="addNewCategory()">
                                    <i class="bi bi-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label for="isbn" class="form-label">ISBN</label>
                            <input type="text" class="form-control" id="isbn" name="isbn">
                        </div>
                        <div class="col-md-3">
                            <label for="publication_year" class="form-label">–ì–æ–¥ –∏–∑–¥–∞–Ω–∏—è</label>
                            <input type="number" class="form-control" id="publication_year" name="publication_year" min="1000" max="2100">
                        </div>
                        <div class="col-md-3">
                            <label for="language" class="form-label">–Ø–∑—ã–∫</label>
                            <select class="form-select" id="language" name="language">
                                <option value="ru" selected>–†—É—Å—Å–∫–∏–π</option>
                                <option value="en">–ê–Ω–≥–ª–∏–π—Å–∫–∏–π</option>
                                <option value="de">–ù–µ–º–µ—Ü–∫–∏–π</option>
                                <option value="fr">–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π</option>
                                <option value="es">–ò—Å–ø–∞–Ω—Å–∫–∏–π</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="pages" class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–∞–Ω–∏—Ü</label>
                            <input type="number" class="form-control" id="pages" name="pages" min="1">
                        </div>
                    </div>

                    <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
                    <div class="mb-3">
                        <label for="description" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ –∫–Ω–∏–≥–∏</label>
                        <textarea class="form-control" id="description" name="description" rows="4"></textarea>
                    </div>

                    <!-- –§–∞–π–ª—ã –∏ —Å—Å—ã–ª–∫–∏ -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="file_url" class="form-label">–§–∞–π–ª –∫–Ω–∏–≥–∏</label>
                            <input type="text" class="form-control mb-2" id="file_url" name="file_url" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: /static/books/test.pdf">
                            <div class="input-group">
                                <input type="file" class="form-control" id="file_upload" accept=".pdf,.epub,.fb2,.mobi,.txt">
                                <button type="button" class="btn btn-outline-secondary" onclick="uploadBookFile()">
                                    –ó–∞–≥—Ä—É–∑–∏—Ç—å
                                </button>
                            </div>
                            <div class="form-text">–ú–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å –≥–æ—Ç–æ–≤—ã–π URL –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª (PDF/EPUB –∏ –¥—Ä.).</div>
                        </div>
                        <div class="col-md-6">
                            <label for="cover_url" class="form-label">–û–±–ª–æ–∂–∫–∞</label>
                            <input type="text" class="form-control mb-2" id="cover_url" name="cover_url" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: /static/covers/test.jpg">
                            <div class="input-group">
                                <input type="file" class="form-control" id="cover_upload" accept="image/*">
                                <button type="button" class="btn btn-outline-secondary" onclick="uploadCoverImage()">
                                    –ó–∞–≥—Ä—É–∑–∏—Ç—å
                                </button>
                            </div>
                            <div class="form-text">–ú–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å –≥–æ—Ç–æ–≤—ã–π URL –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.</div>
                        </div>
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
                    <div class="d-flex justify-content-between">
                        <a href="/admin" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ –∞–¥–º–∏–Ω–∫–µ
                        </a>
                        <button type="submit" class="btn btn-success" id="submitBtn">
                            <i class="bi bi-check-circle"></i> –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–∏–≥—É
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
        <div id="messageContainer" class="mt-3"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let authorsList = [];
let categoriesList = [];
let tempAuthors = [];
let tempCategories = [];
let currentEditBookId = null;

function getQueryParam(name) {
    const params = new URLSearchParams(window.location.search);
    return params.get(name);
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    const userRole = document.body.getAttribute('data-user-role');
    const isAuthenticated = document.body.getAttribute('data-user-authenticated') === 'true';
    
    console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤:', { isAuthenticated, userRole });
    
    if (!isAuthenticated) {
        showMessage('‚ùå –í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.', 'danger');
        setTimeout(() => window.location.href = '/login', 2000);
        return;
    }
    
    if (userRole !== 'admin' && userRole !== 'librarian') {
        showMessage('‚ùå –¢—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏–ª–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ä—è –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ.', 'danger');
        setTimeout(() => window.location.href = '/admin', 2000);
        return;
    }
    
    console.log('‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –ø—Ä–æ–π–¥–µ–Ω–∞');

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —ç—Ç–æ –∏–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ
    const bookIdParam = getQueryParam('book_id');
    if (bookIdParam) {
        currentEditBookId = parseInt(bookIdParam);
        document.title = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–∏–≥—É - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å';
        const h1 = document.querySelector('h1');
        if (h1) h1.innerHTML = '<i class="bi bi-pencil-square"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–∏–≥—É';
        const submitBtn = document.getElementById('submitBtn');
        if (submitBtn) submitBtn.innerHTML = '<i class="bi bi-check-circle"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∞–≤—Ç–æ—Ä–æ–≤ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π, –∑–∞—Ç–µ–º (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ) –∫–Ω–∏–≥–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    Promise.all([loadAuthors(), loadCategories()]).then(() => {
        if (currentEditBookId) {
            loadBookForEdit(currentEditBookId);
        }
    });

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–æ—Ä–º—ã
    setupForm();
});

async function loadBookForEdit(bookId) {
    try {
        console.log('üì• –ó–∞–≥—Ä—É–∂–∞—é –∫–Ω–∏–≥—É –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:', bookId);
        const response = await fetch(`/api/books/${bookId}`);
        if (!response.ok) {
            console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–Ω–∏–≥—É:', response.status);
            showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–Ω–∏–≥–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è', 'danger');
            return;
        }

        const book = await response.json();

        // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è —Ñ–æ—Ä–º—ã
        document.getElementById('title').value = book.title || '';
        document.getElementById('subtitle').value = book.subtitle || '';
        document.getElementById('isbn').value = book.isbn || '';
        document.getElementById('description').value = book.description || '';
        document.getElementById('publication_year').value = book.publication_year || '';
        document.getElementById('language').value = book.language || 'ru';
        document.getElementById('pages').value = book.pages || '';
        document.getElementById('file_url').value = book.file_url || '';
        document.getElementById('cover_url').value = book.cover_url || '';

        // –û—Ç–º–µ—á–∞–µ–º –∞–≤—Ç–æ—Ä–æ–≤
        const authorsSelect = document.getElementById('authors');
        const authorIds = (book.authors || []).map(a => a.id);
        Array.from(authorsSelect.options).forEach(opt => {
            opt.selected = authorIds.includes(parseInt(opt.value));
        });

        // –û—Ç–º–µ—á–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        const categoriesSelect = document.getElementById('categories');
        const categoryIds = (book.categories || []).map(c => c.id);
        Array.from(categoriesSelect.options).forEach(opt => {
            opt.selected = categoryIds.includes(parseInt(opt.value));
        });

        console.log('‚úÖ –§–æ—Ä–º–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ –¥–∞–Ω–Ω—ã–º–∏ –∫–Ω–∏–≥–∏');
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–Ω–∏–≥–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
        showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∫–Ω–∏–≥–∏', 'danger');
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∞–≤—Ç–æ—Ä–æ–≤
async function loadAuthors() {
    try {
        console.log('üì• –ó–∞–≥—Ä—É–∂–∞—é –∞–≤—Ç–æ—Ä–æ–≤...');
        const response = await fetch('/api/books/authors');
        if (response.ok) {
            authorsList = await response.json();
            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∞–≤—Ç–æ—Ä–æ–≤ –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É: —Å–Ω–∞—á–∞–ª–∞ –ø–æ —Ñ–∞–º–∏–ª–∏–∏, –∑–∞—Ç–µ–º –ø–æ –∏–º–µ–Ω–∏
            authorsList.sort((a, b) => {
                const lastA = (a.last_name || '').toLowerCase();
                const lastB = (b.last_name || '').toLowerCase();
                if (lastA < lastB) return -1;
                if (lastA > lastB) return 1;
                const firstA = (a.first_name || '').toLowerCase();
                const firstB = (b.first_name || '').toLowerCase();
                if (firstA < firstB) return -1;
                if (firstA > firstB) return 1;
                return 0;
            });

            const select = document.getElementById('authors');
            
            // –û—á–∏—â–∞–µ–º –æ–ø—Ü–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏
            select.innerHTML = '';
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∞–≤—Ç–æ—Ä–æ–≤
            authorsList.forEach(author => {
                const option = document.createElement('option');
                option.value = author.id;
                option.textContent = `${author.first_name} ${author.last_name}`;
                select.appendChild(option);
            });
            
            console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∞–≤—Ç–æ—Ä–æ–≤: ${authorsList.length}`);
        } else {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤—Ç–æ—Ä–æ–≤:', response.status);
            showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤—Ç–æ—Ä–æ–≤', 'danger');
        }
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤—Ç–æ—Ä–æ–≤:', error);
        showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤—Ç–æ—Ä–æ–≤', 'danger');
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
async function loadCategories() {
    try {
        console.log('üì• –ó–∞–≥—Ä—É–∂–∞—é –∫–∞—Ç–µ–≥–æ—Ä–∏–∏...');
        const response = await fetch('/api/books/categories');
        if (response.ok) {
            categoriesList = await response.json();
            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É –ø–æ –∏–º–µ–Ω–∏
            categoriesList.sort((a, b) => {
                const nameA = (a.name || '').toLowerCase();
                const nameB = (b.name || '').toLowerCase();
                if (nameA < nameB) return -1;
                if (nameA > nameB) return 1;
                return 0;
            });

            const select = document.getElementById('categories');
            
            // –û—á–∏—â–∞–µ–º –æ–ø—Ü–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏
            select.innerHTML = '';
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            categoriesList.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                select.appendChild(option);
            });
            
            console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–π: ${categoriesList.length}`);
        } else {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:', response.status);
            showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π', 'danger');
        }
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:', error);
        showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π', 'danger');
    }
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∞–≤—Ç–æ—Ä–∞ (—á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω—Å–∫–∏–π API)
async function addNewAuthor() {
    const firstName = document.getElementById('newAuthorFirstName').value.trim();
    const lastName = document.getElementById('newAuthorLastName').value.trim();
    
    if (!firstName || !lastName) {
        showMessage('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—é –∞–≤—Ç–æ—Ä–∞', 'warning');
        return;
    }

    try {
        const response = await fetch('/api/admin/authors?first_name=' + encodeURIComponent(firstName) + '&last_name=' + encodeURIComponent(lastName), {
            method: 'POST',
            credentials: 'include'
        });

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            const msg = errorData.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∞–≤—Ç–æ—Ä–∞';
            showMessage(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞–≤—Ç–æ—Ä–∞: ${msg}`, 'danger');
            return;
        }

        const author = await response.json();

        // –î–æ–±–∞–≤–ª—è–µ–º –≤ select —Å —Ä–µ–∞–ª—å–Ω—ã–º ID
        const select = document.getElementById('authors');
        const option = document.createElement('option');
        option.value = author.id;
        option.textContent = `${author.first_name} ${author.last_name}`;
        option.selected = true;
        select.appendChild(option);

        // –û—á–∏—â–∞–µ–º –ø–æ–ª—è –≤–≤–æ–¥–∞
        document.getElementById('newAuthorFirstName').value = '';
        document.getElementById('newAuthorLastName').value = '';

        showMessage(`–ê–≤—Ç–æ—Ä "${author.first_name} ${author.last_name}" —Å–æ–∑–¥–∞–Ω –∏ –¥–æ–±–∞–≤–ª–µ–Ω`, 'success');
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞–≤—Ç–æ—Ä–∞:', error);
        showMessage('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞–≤—Ç–æ—Ä–∞', 'danger');
    }
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (—á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω—Å–∫–∏–π API)
async function addNewCategory() {
    const name = document.getElementById('newCategoryName').value.trim();
    
    if (!name) {
        showMessage('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏', 'warning');
        return;
    }

    try {
        const response = await fetch('/api/admin/categories?name=' + encodeURIComponent(name), {
            method: 'POST',
            credentials: 'include'
        });

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            const msg = errorData.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é';
            showMessage(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: ${msg}`, 'danger');
            return;
        }

        const category = await response.json();

        const select = document.getElementById('categories');
        const option = document.createElement('option');
        option.value = category.id;
        option.textContent = category.name;
        option.selected = true;
        select.appendChild(option);

        document.getElementById('newCategoryName').value = '';

        showMessage(`–ö–∞—Ç–µ–≥–æ—Ä–∏—è "${category.name}" —Å–æ–∑–¥–∞–Ω–∞ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞`, 'success');
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:', error);
        showMessage('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏', 'danger');
    }
}

// –£–¥–∞–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ—Ä–æ–≤ –∏–∑ —Å–ø–∏—Å–∫–∞ (—Ç–æ–ª—å–∫–æ –Ω–∞ —Ñ–æ—Ä–º–µ)
function removeSelectedAuthors() {
    const select = document.getElementById('authors');
    if (!select) return;
    const selected = Array.from(select.selectedOptions);
    if (selected.length === 0) {
        showMessage('–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ—Ä–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è', 'warning');
        return;
    }
    selected.forEach(opt => opt.remove());
}

// –ü–æ–ª–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ—Ä–æ–≤ –∏–∑ —Å–∏—Å—Ç–µ–º—ã (–µ—Å–ª–∏ –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ –∫–Ω–∏–≥–∞–º)
async function deleteSelectedAuthorsPermanently() {
    const select = document.getElementById('authors');
    if (!select) return;
    const selected = Array.from(select.selectedOptions);
    if (selected.length === 0) {
        showMessage('–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ—Ä–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è', 'warning');
        return;
    }

    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ—Ä–æ–≤ –∏–∑ —Å–∏—Å—Ç–µ–º—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
        return;
    }

    for (const opt of selected) {
        const id = parseInt(opt.value);
        if (!id) {
            // –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
            continue;
        }
        try {
            const response = await fetch(`/api/admin/authors/${id}`, {
                method: 'DELETE',
                credentials: 'include'
            });

            if (response.ok) {
                opt.remove();
            } else {
                const errorData = await response.json().catch(() => ({}));
                const msg = errorData.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∞–≤—Ç–æ—Ä–∞';
                showMessage(`‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∞–≤—Ç–æ—Ä–∞ ID ${id}: ${msg}`, 'danger');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∞–≤—Ç–æ—Ä–∞:', error);
            showMessage(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∞–≤—Ç–æ—Ä–∞ ID ${id}`, 'danger');
        }
    }
}

// –£–¥–∞–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏–∑ —Å–ø–∏—Å–∫–∞ (—Ç–æ–ª—å–∫–æ –Ω–∞ —Ñ–æ—Ä–º–µ)
function removeSelectedCategories() {
    const select = document.getElementById('categories');
    if (!select) return;
    const selected = Array.from(select.selectedOptions);
    if (selected.length === 0) {
        showMessage('–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è', 'warning');
        return;
    }
    selected.forEach(opt => opt.remove());
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–æ—Ä–º—ã
function setupForm() {
    const form = document.getElementById('addBookForm');
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
        const formData = new FormData(form);
        const data = {};
        
        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º FormData –≤ –æ–±—ä–µ–∫—Ç
        for (let [key, value] of formData.entries()) {
            if (key === 'author_ids' || key === 'category_ids') {
                // –î–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö select –ø–æ–ª—É—á–∞–µ–º –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è
                if (!data[key]) data[key] = [];
                // –í—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è —Ç–µ–ø–µ—Ä—å —Ä–µ–∞–ª—å–Ω—ã–µ —á–∏—Å–ª–æ–≤—ã–µ ID
                data[key].push(parseInt(value));
            } else if (key === 'pages' || key === 'publication_year') {
                data[key] = value ? parseInt(value) : null;
            } else {
                data[key] = value;
            }
        }
        
        // –û—á–∏—â–∞–µ–º –ø—É—Å—Ç—ã–µ –º–∞—Å—Å–∏–≤—ã
        if (data.author_ids && data.author_ids.length === 0) {
            data.author_ids = [];
        }
        if (data.category_ids && data.category_ids.length === 0) {
            data.category_ids = [];
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
        if (!data.language) data.language = 'ru';
        
        console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ:', data);
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
        await submitBookData(data);
    });
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –∫–Ω–∏–≥–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω—Å–∫–∏–π —ç–Ω–¥–ø–æ–∏–Ω—Ç
async function uploadBookFile() {
    const fileInput = document.getElementById('file_upload');
    const urlInput = document.getElementById('file_url');

    if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
        showMessage('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∫–Ω–∏–≥–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏', 'warning');
        return;
    }

    const file = fileInput.files[0];
    const formData = new FormData();
    formData.append('file', file);

    try {
        const response = await fetch('/api/admin/upload/book-file', {
            method: 'POST',
            credentials: 'include',
            body: formData
        });

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            const msg = errorData.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª –∫–Ω–∏–≥–∏';
            showMessage(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ –∫–Ω–∏–≥–∏: ${msg}`, 'danger');
            return;
        }

        const result = await response.json();
        if (result.url && urlInput) {
            urlInput.value = result.url;
            showMessage('‚úÖ –§–∞–π–ª –∫–Ω–∏–≥–∏ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω', 'success');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ –∫–Ω–∏–≥–∏:', error);
        showMessage('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞ –∫–Ω–∏–≥–∏', 'danger');
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±–ª–æ–∂–∫–∏ –∫–Ω–∏–≥–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω—Å–∫–∏–π —ç–Ω–¥–ø–æ–∏–Ω—Ç
async function uploadCoverImage() {
    const fileInput = document.getElementById('cover_upload');
    const urlInput = document.getElementById('cover_url');

    if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
        showMessage('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –æ–±–ª–æ–∂–∫–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏', 'warning');
        return;
    }

    const file = fileInput.files[0];
    const formData = new FormData();
    formData.append('file', file);

    try {
        const response = await fetch('/api/admin/upload/cover', {
            method: 'POST',
            credentials: 'include',
            body: formData
        });

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            const msg = errorData.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±–ª–æ–∂–∫—É';
            showMessage(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±–ª–æ–∂–∫–∏: ${msg}`, 'danger');
            return;
        }

        const result = await response.json();
        if (result.url && urlInput) {
            urlInput.value = result.url;
            showMessage('‚úÖ –û–±–ª–æ–∂–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'success');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±–ª–æ–∂–∫–∏:', error);
        showMessage('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ–±–ª–æ–∂–∫–∏', 'danger');
    }
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∫–Ω–∏–≥–∏
async function submitBookData(data) {
    const submitBtn = document.getElementById('submitBtn');
    const originalText = submitBtn.innerHTML;
    
    try {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        submitBtn.disabled = true;
        submitBtn.innerHTML = `
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            –î–æ–±–∞–≤–ª–µ–Ω–∏–µ...
        `;
        
        let response;

        if (currentEditBookId) {
            console.log('üîÑ –û–±–Ω–æ–≤–ª—è—é —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∫–Ω–∏–≥—É —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω—Å–∫–∏–π —ç–Ω–¥–ø–æ–∏–Ω—Ç...');
            response = await fetch(`/api/admin/books/${currentEditBookId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify(data)
            });
        } else {
            console.log('üîÑ –°–æ–∑–¥–∞—é –Ω–æ–≤—É—é –∫–Ω–∏–≥—É —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω—Å–∫–∏–π —ç–Ω–¥–ø–æ–∏–Ω—Ç...');
            response = await fetch('/api/admin/books', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify(data)
            });
        }
        
        if (response.ok) {
            const result = await response.json();
            if (currentEditBookId) {
                showMessage(`‚úÖ –ö–Ω–∏–≥–∞ "${result.title}" —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞! ID: ${result.id}`, 'success');
            } else {
                showMessage(`‚úÖ –ö–Ω–∏–≥–∞ "${result.title}" —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞! ID: ${result.id}`, 'success');
            }
            
            // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('addBookForm').reset();
            
            // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                window.location.href = `/book/${result.id}`;
            }, 3000);
            
        } else {
            let errorText = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
            try {
                const errorData = await response.json();
                errorText = errorData.detail || JSON.stringify(errorData);
            } catch (e) {
                errorText = await response.text().catch(() => '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏');
            }
            
            console.error('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:', errorText);
            showMessage(`‚ùå –û—à–∏–±–∫–∞: ${errorText}`, 'danger');
            
            // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            if (response.status === 401 || response.status === 403) {
                showMessage('‚ö†Ô∏è  –ü—Ä–æ–±–ª–µ–º–∞ —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –≤—ã –≤–æ—à–ª–∏ –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä.', 'warning');
            }
        }
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
        showMessage(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, 'danger');
    } finally {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function showMessage(text, type) {
    const container = document.getElementById('messageContainer');
    
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    alert.innerHTML = `
        ${text}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    container.innerHTML = '';
    container.appendChild(alert);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    if (type !== 'danger') {
        setTimeout(() => {
            if (alert.parentNode) {
                alert.remove();
            }
        }, 5000);
    }
}

function getCookie(name) {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [cookieName, cookieValue] = cookie.trim().split('=');
        if (cookieName === name) {
            return cookieValue;
        }
    }
    return null;
}

// –¢–µ—Å—Ç–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–Ω–∏–≥–∏ –Ω–∞–ø—Ä—è–º—É—é
window.createTestBook = async function() {
    const testData = {
        title: "–¢–µ—Å—Ç–æ–≤–∞—è –∫–Ω–∏–≥–∞",
        subtitle: "–°–æ–∑–¥–∞–Ω–Ω–∞—è —á–µ—Ä–µ–∑ –∫–æ–Ω—Å–æ–ª—å",
        description: "–≠—Ç–∞ –∫–Ω–∏–≥–∞ —Å–æ–∑–¥–∞–Ω–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è",
        publication_year: 2024,
        language: "ru",
        pages: 100,
        author_ids: [],
        category_ids: []
    };
    
    console.log('üîÑ –¢–µ—Å—Ç–∏—Ä—É—é —Å–æ–∑–¥–∞–Ω–∏–µ –∫–Ω–∏–≥–∏...');
    await submitBookData(testData);
};
</script>
{% endblock %}