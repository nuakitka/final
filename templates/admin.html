{% extends "base.html" %}

{% block title %}Админ-панель - Онлайн библиотека{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="bi bi-speedometer2"></i> Админ-панель
            <small class="text-muted fs-6">Управление библиотекой</small>
        </h1>
        
        <!-- Сообщение о недостаточных правах -->
        <div id="accessDeniedMessage" class="alert alert-danger d-none">
            <h4><i class="bi bi-shield-exclamation"></i> Доступ запрещен</h4>
            <p>Для доступа к админ-панели требуются права администратора или библиотекаря.</p>
            <a href="/" class="btn btn-primary">На главную</a>
        </div>

        <!-- Контент админ-панели (изначально скрыт) -->
        <div id="adminContent" style="display: none;">
            <!-- Статистика -->
            <div class="row mb-4" id="adminStats">
                <div class="col-md-2">
                    <div class="card text-white bg-primary">
                        <div class="card-body text-center">
                            <h4 id="totalUsers">0</h4>
                            <p class="card-text">Пользователей</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card text-white bg-success">
                        <div class="card-body text-center">
                            <h4 id="totalBooks">0</h4>
                            <p class="card-text">Книг</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card text-white bg-warning">
                        <div class="card-body text-center">
                            <h4 id="totalReviews">0</h4>
                            <p class="card-text">Рецензий</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card text-white bg-info">
                        <div class="card-body text-center">
                            <h4 id="totalSessions">0</h4>
                            <p class="card-text">Сессий чтения</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body text-center">
                            <h4>Быстрые действия</h4>
                            <div class="btn-group-vertical w-100">
                                <button class="btn btn-outline-primary btn-sm mb-1" onclick="showSection('users')">
                                    Управление пользователями
                                </button>
                                <button class="btn btn-outline-success btn-sm mb-1" onclick="showSection('books')">
                                    Управление книгами
                                </button>
                                <button class="btn btn-outline-info btn-sm" onclick="showSection('stats')">
                                    Подробная статистика
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Секции админ-панели -->
            <div id="adminSections">
                <!-- Секция пользователей -->
                <div class="card mb-4" id="usersSection" style="display: none;">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-people"></i> Управление пользователями
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Имя пользователя</th>
                                        <th>Email</th>
                                        <th>Роль</th>
                                        <th>Статус</th>
                                        <th>Действия</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTable">
                                    <tr>
                                        <td colspan="6" class="text-center">
                                            <div class="spinner-border" role="status">
                                                <span class="visually-hidden">Загрузка...</span>
                                            </div>
                                            <p class="mt-2">Загрузка пользователей...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Секция книг -->
                <div class="card mb-4" id="booksSection" style="display: none;">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-book"></i> Управление книгами
                        </h5>
                        <a href="/admin/add-book" class="btn btn-success btn-sm">
                            <i class="bi bi-plus-circle"></i> Добавить книгу
                        </a>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Название</th>
                                        <th>Автор</th>
                                        <th>Год</th>
                                        <th>Рейтинг</th>
                                        <th>Статус</th>
                                        <th>Действия</th>
                                    </tr>
                                </thead>
                                <tbody id="booksTable">
                                    <tr>
                                        <td colspan="7" class="text-center">
                                            <div class="spinner-border" role="status">
                                                <span class="visually-hidden">Загрузка...</span>
                                            </div>
                                            <p class="mt-2">Загрузка книг...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <!-- Секция статистики -->
                <div class="card" id="statsSection" style="display: none;">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-graph-up"></i> Подробная статистика
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="detailedStats">
                            <div class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Загрузка...</span>
                                </div>
                                <p class="mt-2">Загрузка статистики...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}
{% block extra_js %}
<script>
// Проверка прав доступа (админ или библиотекарь)
function checkAdminAccess() {
    const userRole = document.body.getAttribute('data-user-role');
    const isAuthenticated = document.body.getAttribute('data-user-authenticated') === 'true';

    if (!isAuthenticated || (userRole !== 'admin' && userRole !== 'librarian')) {
        // Показать сообщение об ошибке
        document.getElementById('accessDeniedMessage').classList.remove('d-none');
        document.getElementById('adminContent').style.display = 'none';
        
        // Автоматическое перенаправление через 3 секунды
        setTimeout(() => {
            window.location.href = '/';
        }, 3000);
        
        return false;
    }
    
    // Показать админ-панель
    document.getElementById('accessDeniedMessage').classList.add('d-none');
    document.getElementById('adminContent').style.display = 'block';
    return true;
}

// Загрузка статистики админ-панели
async function loadAdminStats() {
    try {
        const response = await fetch('/api/admin/stats', {
            credentials: 'include'
        });
        
        if (response.ok) {
            const stats = await response.json();
            
            document.getElementById('totalUsers').textContent = stats.total_users;
            document.getElementById('totalBooks').textContent = stats.total_books;
            document.getElementById('totalReviews').textContent = stats.total_reviews;
            document.getElementById('totalSessions').textContent = stats.total_reading_sessions;
        } else if (response.status === 403) {
            // Нет прав доступа
            showAccessDenied();
        }
    } catch (error) {
        console.error('Ошибка загрузки статистики:', error);
        showErrorMessage('Ошибка загрузки статистики');
    }
}

// Показать сообщение об ошибке доступа
function showAccessDenied() {
    document.getElementById('accessDeniedMessage').classList.remove('d-none');
    document.getElementById('adminContent').style.display = 'none';
}

// Показать секцию
function showSection(sectionName) {
    if (!checkAdminAccess()) return;
    
    // Скрыть все секции
    document.getElementById('usersSection').style.display = 'none';
    document.getElementById('booksSection').style.display = 'none';
    document.getElementById('statsSection').style.display = 'none';
    
    // Показать выбранную секцию
    document.getElementById(sectionName + 'Section').style.display = 'block';
    
    // Загрузить данные для секции
    if (sectionName === 'users') {
        loadUsers();
    } else if (sectionName === 'books') {
        loadBooks();
    } else if (sectionName === 'stats') {
        loadDetailedStats();
    }
}

// Загрузка пользователей
async function loadUsers() {
    try {
        const response = await fetch('/api/admin/users', {
            credentials: 'include'
        });
        
        if (response.ok) {
            const users = await response.json();
            const table = document.getElementById('usersTable');
            
            let html = '';
            users.forEach(user => {
                html += `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.username}</td>
                        <td>${user.email}</td>
                        <td>
                            <select class="form-select form-select-sm" onchange="updateUserRole(${user.id}, this.value)">
                                <option value="reader" ${user.role === 'reader' ? 'selected' : ''}>Читатель</option>
                                <option value="librarian" ${user.role === 'librarian' ? 'selected' : ''}>Библиотекарь</option>
                                <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Администратор</option>
                            </select>
                        </td>
                        <td>
                            <span class="badge ${user.is_active ? 'bg-success' : 'bg-danger'}">
                                ${user.is_active ? 'Активен' : 'Неактивен'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="toggleUserStatus(${user.id}, ${!user.is_active})">
                                ${user.is_active ? 'Деактивировать' : 'Активировать'}
                            </button>
                        </td>
                    </tr>
                `;
            });
            table.innerHTML = html;
        } else if (response.status === 403) {
            showAccessDenied();
        }
    } catch (error) {
        console.error('Ошибка загрузки пользователей:', error);
        showErrorMessage('Ошибка загрузки пользователей');
    }
}

// Загрузка книг
async function loadBooks() {
    try {
        const response = await fetch('/api/books?limit=1000', {
            credentials: 'include'
        });

        if (response.ok) {
            const books = await response.json();
            const table = document.getElementById('booksTable');
            
            let html = '';
            books.forEach(book => {
                html += `
                    <tr>
                        <td>${book.id}</td>
                        <td>${book.title}</td>
                        <td>${book.authors.map(a => `${a.first_name} ${a.last_name}`).join(', ')}</td>
                        <td>${book.publication_year || '-'}</td>
                        <td>${book.rating ? book.rating.toFixed(1) : 'Нет'}</td>
                        <td>
                            <span class="badge ${book.is_active ? 'bg-success' : 'bg-danger'}">
                                ${book.is_active ? 'Активна' : 'Неактивна'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-primary btn-sm me-1" onclick="editBook(${book.id})">
                                Редактировать
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteBook(${book.id})">
                                Удалить
                            </button>
                        </td>
                    </tr>
                `;
            });
            table.innerHTML = html;
        } else if (response.status === 403) {
            showAccessDenied();
        }
    } catch (error) {
        console.error('Ошибка загрузки книг:', error);
        showErrorMessage('Ошибка загрузки книг');
    }
}

// Функции управления пользователями
async function updateUserRole(userId, newRole) {
    if (!confirm(`Изменить роль пользователя ${userId} на "${newRole}"?`)) return;

    try {
        const response = await fetch(`/api/admin/users/${userId}/role?new_role=${encodeURIComponent(newRole)}`, {
            method: 'PATCH',
            credentials: 'include'
        });

        if (response.ok) {
            showMessage('Роль пользователя обновлена', 'success');
            loadUsers();
        } else {
            const error = await response.json();
            showMessage(`Ошибка обновления роли: ${error.detail || response.status}`, 'danger');
        }
    } catch (error) {
        console.error('Ошибка обновления роли пользователя:', error);
        showMessage('Ошибка обновления роли пользователя', 'danger');
    }
}

async function toggleUserStatus(userId, newStatus) {
    const actionText = newStatus ? 'активировать' : 'деактивировать';
    if (!confirm(`Вы уверены, что хотите ${actionText} пользователя ${userId}?`)) return;

    try {
        const response = await fetch(`/api/admin/users/${userId}/status?is_active=${newStatus}`, {
            method: 'PATCH',
            credentials: 'include'
        });

        if (response.ok) {
            showMessage('Статус пользователя обновлён', 'success');
            loadUsers();
        } else {
            const error = await response.json();
            showMessage(`Ошибка обновления статуса: ${error.detail || response.status}`, 'danger');
        }
    } catch (error) {
        console.error('Ошибка изменения статуса пользователя:', error);
        showMessage('Ошибка изменения статуса пользователя', 'danger');
    }
}

// Удалите функцию showAddBookForm() и замените её:

function viewAddBookPage() {
    window.location.href = '/admin/add-book';
}

// Обновлённые обработчики кнопок в таблице книг
function editBook(bookId) {
    // Переходим на страницу добавления книги в режиме редактирования
    window.location.href = `/admin/add-book?book_id=${bookId}`;
}

async function deleteBook(bookId) {
    if (!confirm(`Вы уверены, что хотите удалить книгу ${bookId}?`)) return;

    try {
        const response = await fetch(`/api/admin/books/${bookId}`, {
            method: 'DELETE',
            credentials: 'include'
        });

        if (response.ok) {
            showMessage('Книга успешно удалена', 'success');
            loadBooks();
        } else {
            const error = await response.json().catch(() => ({}));
            showMessage(`Ошибка удаления книги: ${error.detail || response.status}`, 'danger');
        }
    } catch (error) {
        console.error('Ошибка удаления книги:', error);
        showMessage('Ошибка удаления книги', 'danger');
    }
}

function showMessage(text, type) {
    // Создайте временное сообщение
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
    alert.style.zIndex = '1050';
    alert.innerHTML = `
        ${text}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alert);
    
    // Автоматически скрываем через 5 секунд
    setTimeout(() => {
        alert.remove();
    }, 5000);
}

// (Устаревшие заглушки editBook/deleteBook были заменены рабочими реализациями выше)

// Показать сообщение об ошибке
function showErrorMessage(message) {
    alert('Ошибка: ' + message);
}

// Загрузка детальной статистики
async function loadDetailedStats() {
    try {
        const response = await fetch('/api/admin/stats', {
            credentials: 'include'
        });
        
        if (response.ok) {
            const stats = await response.json();
            const container = document.getElementById('detailedStats');
            
            let html = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Общая статистика</h6>
                        <ul class="list-group">
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Всего пользователей:</span>
                                <strong>${stats.total_users}</strong>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Всего книг:</span>
                                <strong>${stats.total_books}</strong>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Всего рецензий:</span>
                                <strong>${stats.total_reviews}</strong>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Сессий чтения:</span>
                                <strong>${stats.total_reading_sessions}</strong>
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Популярные книги</h6>
                        <ul class="list-group">
            `;
            
            if (stats.popular_books && stats.popular_books.length > 0) {
                stats.popular_books.forEach(book => {
                    html += `
                        <li class="list-group-item">
                            <div>${book.title}</div>
                            <small class="text-muted">Просмотры: ${book.views}, Скачивания: ${book.downloads}</small>
                        </li>
                    `;
                });
            } else {
                html += `<li class="list-group-item text-muted">Нет данных</li>`;
            }
            
            html += `
                        </ul>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        } else if (response.status === 403) {
            showAccessDenied();
        }
    } catch (error) {
        console.error('Ошибка загрузки детальной статистики:', error);
        showErrorMessage('Ошибка загрузки статистики');
    }
}

// Инициализация админ-панели
document.addEventListener('DOMContentLoaded', function() {
    // Проверяем доступ при загрузке
    if (checkAdminAccess()) {
        loadAdminStats();
        // По умолчанию показываем секцию пользователей
        showSection('users');
    }
});
</script>
{% endblock extra_js %}
