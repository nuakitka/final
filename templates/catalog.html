{% extends "base.html" %}

{% block title %}Каталог книг - Онлайн библиотека{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">Каталог книг</h1>
        
        <!-- Фильтры и поиск -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <input type="text" class="form-control" id="searchInput" placeholder="Поиск по названию, автору...">
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="categoryFilter">
                            <option value="">Все категории</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="authorFilter">
                            <option value="">Все авторы</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary w-100" onclick="searchBooks()">Найти</button>
                    </div>
                </div>
                
                <!-- Дополнительные фильтры -->
                <div class="row g-3 mt-2" id="advancedFilters" style="display: none;">
                    <div class="col-md-3">
                        <select class="form-select" id="languageFilter">
                            <option value="">Все языки</option>
                            <option value="ru">Русский</option>
                            <option value="en">Английский</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <input type="number" class="form-control" id="yearFrom" placeholder="Год от">
                    </div>
                    <div class="col-md-2">
                        <input type="number" class="form-control" id="yearTo" placeholder="Год до">
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">Сбросить</button>
                    </div>
                </div>
                
                <div class="mt-2 d-flex justify-content-between align-items-center">
                    <div>
                        <a href="#" class="small text-decoration-none me-3" onclick="toggleAdvancedFilters()">
                            <i class="bi bi-funnel"></i> Расширенные фильтры
                        </a>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="favoritesOnly" onchange="searchBooks(1)">
                            <label class="form-check-label small" for="favoritesOnly">Только избранные</label>
                        </div>
                    </div>
                    
                    {% if request.state.user and request.state.user.role in ['admin', 'librarian'] %}
                    <a href="/admin/add-book" class="btn btn-success btn-sm">
                        <i class="bi bi-plus-circle"></i> Добавить книгу
                    </a>

                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Результаты поиска -->
        <div id="booksResults">
            <div class="text-center py-5">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Загрузка...</span>
                </div>
                <p class="mt-2">Загрузка книг...</p>
            </div>
        </div>

        <!-- Пагинация -->
        <nav aria-label="Page navigation" id="pagination" style="display: none;">
            <ul class="pagination justify-content-center">
                <li class="page-item disabled">
                    <a class="page-link" href="#" tabindex="-1">Назад</a>
                </li>
                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                <li class="page-item"><a class="page-link" href="#">2</a></li>
                <li class="page-item"><a class="page-link" href="#">3</a></li>
                <li class="page-item">
                    <a class="page-link" href="#">Вперед</a>
                </li>
            </ul>
        </nav>
    </div>
</div>

{% block extra_js %}
<script>
let currentPage = 1;
const booksPerPage = 12;
let favoriteBookIds = new Set();

// Загрузка фильтров
async function loadFilters() {
    try {
        // Загрузка категорий
        const categoriesResponse = await fetch('/api/books/categories');
        if (categoriesResponse.ok) {
            const categories = await categoriesResponse.json();
            const categorySelect = document.getElementById('categoryFilter');
            
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                categorySelect.appendChild(option);
            });
        }

        // Загрузка авторов
        const authorsResponse = await fetch('/api/books/authors');
        if (authorsResponse.ok) {
            const authors = await authorsResponse.json();
            const authorSelect = document.getElementById('authorFilter');
            
            authors.forEach(author => {
                const option = document.createElement('option');
                option.value = author.id;
                option.textContent = `${author.first_name} ${author.last_name}`;
                authorSelect.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Ошибка загрузки фильтров:', error);
    }
}

// Загрузка избранных книг текущего пользователя (если авторизован)
async function loadFavorites() {
    try {
        const response = await fetch('/api/users/me/favorites', {
            credentials: 'include'
        });
        if (response.ok) {
            const favorites = await response.json();
            favoriteBookIds = new Set(favorites.map(b => b.id));
        } else if (response.status === 401) {
            favoriteBookIds = new Set();
        }
    } catch (error) {
        console.error('Ошибка загрузки избранных книг:', error);
    }
}

// Поиск книг
async function searchBooks(page = 1) {
    const searchQuery = document.getElementById('searchInput').value;
    const categoryId = document.getElementById('categoryFilter').value;
    const authorId = document.getElementById('authorFilter').value;
    const language = document.getElementById('languageFilter').value;
    const yearFrom = document.getElementById('yearFrom').value;
    const yearTo = document.getElementById('yearTo').value;

    let url = '/api/books/search?';
    const params = new URLSearchParams({
        query: searchQuery || '',
        skip: (page - 1) * booksPerPage,
        limit: booksPerPage
    });

    if (categoryId) params.append('category_id', categoryId);
    if (authorId) params.append('author_id', authorId);
    if (language) params.append('language', language);
    if (yearFrom) params.append('year_min', yearFrom);
    if (yearTo) params.append('year_max', yearTo);

    try {
        const response = await fetch(url + params.toString());
        if (response.ok) {
            const books = await response.json();

            const favoritesOnly = document.getElementById('favoritesOnly')?.checked;
            const filteredBooks = favoritesOnly
                ? books.filter(b => favoriteBookIds.has(b.id))
                : books;

            displayBooks(filteredBooks);
            currentPage = page;
            updatePagination();
        }
    } catch (error) {
        console.error('Ошибка поиска книг:', error);
    }
}

// Отображение книг
function displayBooks(books) {
    const container = document.getElementById('booksResults');
    
    if (books.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="bi bi-search" style="font-size: 3rem;"></i>
                <h4 class="mt-3">Книги не найдены</h4>
                <p class="text-muted">Попробуйте изменить параметры поиска</p>
            </div>
        `;
        return;
    }

    let html = '<div class="row">';
    books.forEach(book => {
        const isFavorite = favoriteBookIds.has(book.id);
        html += `
            <div class="col-md-3 mb-4">
                <div class="card h-100 book-card">
                    <div class="card-img-top bg-light d-flex align-items-center justify-content-center" 
                         style="height: 200px; cursor: pointer;" 
                         onclick="viewBook(${book.id})">
                        ${book.cover_url ? 
                            `<img src="${book.cover_url}" class="img-fluid" style="max-height: 100%;" alt="${book.title}">` :
                            `<span class="text-muted">Обложка книги</span>`
                        }
                    </div>
                    <div class="card-body">
                        <h6 class="card-title" style="height: 3rem; overflow: hidden;">${book.title}</h6>
                        <p class="card-text small text-muted">
                            ${book.authors.map(author => `${author.first_name} ${author.last_name}`).join(', ')}
                        </p>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small class="text-muted">${book.publication_year || 'Не указан'}</small>
                            <div class="text-warning small d-flex align-items-center">
                                <span class="me-1">${'★'.repeat(Math.floor(book.rating))}</span>
                                <span>${book.rating ? book.rating.toFixed(1) : 'Нет оценок'}</span>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-primary btn-sm flex-grow-1" onclick="viewBook(${book.id})">
                                Подробнее
                            </button>
                            <button class="btn btn-${isFavorite ? 'danger' : 'outline-danger'} btn-sm" onclick="toggleFavoriteFromCatalog(${book.id}, this)">
                                ${isFavorite ? 'Убрать из избранного' : 'В избранное'}
                            </button>
                        </div>
                        <button class="btn btn-success btn-sm w-100 mt-1" onclick="startReading(${book.id})">
                            Читать
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    container.innerHTML = html;
}

// Вспомогательные функции
function toggleAdvancedFilters() {
    const filters = document.getElementById('advancedFilters');
    filters.style.display = filters.style.display === 'none' ? 'block' : 'none';
}

function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('categoryFilter').value = '';
    document.getElementById('authorFilter').value = '';
    document.getElementById('languageFilter').value = '';
    document.getElementById('yearFrom').value = '';
    document.getElementById('yearTo').value = '';
    searchBooks(1);
}

function viewBook(bookId) {
    window.location.href = `/book/${bookId}`;
}

function startReading(bookId) {
    window.location.href = `/book/${bookId}?read=true`;
}

function toggleFavoriteFromCatalog(bookId, button) {
    if (typeof toggleFavorite === 'function') {
        toggleFavorite(bookId, button)
            .then(() => {
                // Синхронизируем локальный набор избранного
                if (favoriteBookIds.has(bookId)) {
                    favoriteBookIds.delete(bookId);
                } else {
                    favoriteBookIds.add(bookId);
                }
                // Перерисуем текущую страницу с учётом фильтра
                searchBooks(currentPage);
            })
            .catch(err => {
                console.error('Ошибка обновления избранного:', err);
            });
    }
}

// Инициализация
document.addEventListener('DOMContentLoaded', function() {
    loadFilters();
    loadFavorites().then(() => {
        searchBooks(1);
    }).catch(() => {
        // Если избранное не загрузилось (не авторизован и т.п.), всё равно грузим книги
        searchBooks(1);
    });
    
    // Поиск при нажатии Enter
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchBooks(1);
        }
    });
});
</script>
{% endblock %}
{% endblock %}