{% extends "base.html" %}

{% block title %}Каталог книг - Онлайн-библиотека{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Каталог книг</h1>
    <div class="d-flex">
        <select class="form-select me-2" id="categoryFilter">
            <option value="">Все категории</option>
        </select>
        <select class="form-select me-2" id="sortFilter">
            <option value="title">По названию</option>
            <option value="rating">По рейтингу</option>
            <option value="year">По году</option>
            <option value="views">По популярности</option>
        </select>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-12">
        <div class="input-group">
            <input type="text" class="form-control" placeholder="Поиск по названию, автору, описанию..." id="catalogSearch">
            <button class="btn btn-primary" type="button" onclick="searchCatalog()">
                <i class="fas fa-search"></i> Поиск
            </button>
        </div>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-6">
        <p class="text-muted">Найдено книг: <span id="bookCount">0</span></p>
    </div>
    <div class="col-md-6 text-end">
        <div class="btn-group" role="group">
            <input type="radio" class="btn-check" name="viewMode" id="gridView" autocomplete="off" checked>
            <label class="btn btn-outline-primary" for="gridView"><i class="fas fa-th"></i></label>
            
            <input type="radio" class="btn-check" name="viewMode" id="listView" autocomplete="off">
            <label class="btn btn-outline-primary" for="listView"><i class="fas fa-list"></i></label>
        </div>
    </div>
</div>

<div class="row" id="booksContainer">
    <!-- Books will be loaded dynamically -->
</div>

<div class="d-flex justify-content-center mt-4">
    <nav aria-label="Page navigation">
        <ul class="pagination" id="pagination">
            <!-- Pagination will be loaded dynamically -->
        </ul>
    </nav>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentPage = 1;
let totalPages = 1;
let currentQuery = '';

document.addEventListener('DOMContentLoaded', function() {
    loadCategories();
    loadBooks();
});

function loadCategories() {
    fetch('/api/books/categories/')
        .then(response => response.json())
        .then(categories => {
            const select = document.getElementById('categoryFilter');
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                select.appendChild(option);
            });
        });
}

function loadBooks(page = 1, query = '', categoryId = '', sortBy = 'title') {
    const params = new URLSearchParams({
        skip: (page - 1) * 12,
        limit: 12
    });
    
    if (query) params.append('query', query);
    if (categoryId) params.append('category_id', categoryId);
    
    let url = '/api/books/search?' + params.toString();
    if (!query && !categoryId) {
        url = '/api/books?' + params.toString();
    }
    
    fetch(url)
        .then(response => response.json())
        .then(books => {
            displayBooks(books);
            updatePagination(page);
        });
}

function displayBooks(books) {
    const container = document.getElementById('booksContainer');
    const isGridView = document.getElementById('gridView').checked;
    
    document.getElementById('bookCount').textContent = books.length;
    
    if (isGridView) {
        container.innerHTML = books.map(book => createBookCard(book)).join('');
    } else {
        container.innerHTML = books.map(book => createBookListItem(book)).join('');
    }
}

function createBookCard(book) {
    return `
        <div class="col-md-4 col-lg-3 mb-4">
            <div class="card h-100">
                <img src="${book.cover_url || '/static/images/default-book.jpg'}" class="card-img-top" alt="${book.title}">
                <div class="card-body d-flex flex-column">
                    <h6 class="card-title">${book.title}</h6>
                    <p class="card-text text-muted small">${book.authors?.map(a => a.first_name + ' ' + a.last_name).join(', ') || 'Unknown'}</p>
                    <div class="mt-auto">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-warning">
                                <i class="fas fa-star"></i> ${book.rating || 0}
                            </span>
                            <span class="text-muted small">${book.publication_year || ''}</span>
                        </div>
                        <a href="/book/${book.id}" class="btn btn-sm btn-primary w-100">Подробнее</a>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function createBookListItem(book) {
    return `
        <div class="col-12 mb-3">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-2">
                            <img src="${book.cover_url || '/static/images/default-book.jpg'}" class="img-fluid" alt="${book.title}">
                        </div>
                        <div class="col-md-8">
                            <h5 class="card-title">${book.title}</h5>
                            <p class="text-muted">${book.authors?.map(a => a.first_name + ' ' + a.last_name).join(', ') || 'Unknown'}</p>
                            <p class="card-text">${book.description ? book.description.substring(0, 200) + '...' : ''}</p>
                            <div class="d-flex align-items-center">
                                <span class="text-warning me-3">
                                    <i class="fas fa-star"></i> ${book.rating || 0}
                                </span>
                                <span class="text-muted me-3">${book.publication_year || ''}</span>
                                <span class="text-muted">${book.pages || 0} стр.</span>
                            </div>
                        </div>
                        <div class="col-md-2 text-end">
                            <a href="/book/${book.id}" class="btn btn-primary">Подробнее</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function searchCatalog() {
    currentQuery = document.getElementById('catalogSearch').value;
    currentPage = 1;
    loadBooks(currentPage, currentQuery);
}

function updatePagination(page) {
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';
    
    // Previous button
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${page === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${page - 1})">Назад</a>`;
    pagination.appendChild(prevLi);
    
    // Page numbers
    for (let i = 1; i <= Math.min(5, totalPages); i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === page ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
        pagination.appendChild(li);
    }
    
    // Next button
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${page === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${page + 1})">Вперед</a>`;
    pagination.appendChild(nextLi);
}

function changePage(page) {
    if (page < 1 || page > totalPages) return;
    currentPage = page;
    loadBooks(currentPage, currentQuery);
}

// Event listeners
document.getElementById('categoryFilter').addEventListener('change', function() {
    currentPage = 1;
    loadBooks(currentPage, currentQuery, this.value);
});

document.getElementById('sortFilter').addEventListener('change', function() {
    currentPage = 1;
    loadBooks(currentPage, currentQuery, document.getElementById('categoryFilter').value, this.value);
});

document.getElementById('catalogSearch').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        searchCatalog();
    }
});

// View mode toggle
document.querySelectorAll('input[name="viewMode"]').forEach(radio => {
    radio.addEventListener('change', function() {
        loadBooks(currentPage, currentQuery);
    });
});
</script>
{% endblock %}
